// ==============================================
// PRISMA SCHEMA - ClassCheck
// Sistema de Question√°rios Adaptativos com Stack Recomendado:
// - json-rules-engine (motor de regras)
// - Zod (valida√ß√£o)
// - Zustand (state management)
// - React Hook Form (formul√°rios)
// - TanStack Query (cache/API)
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// MODELOS DO CLASSCHECK
// ==============================================

// Modelo Usuario
model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  nome      String
  avatar    String?
  role      Role     @default(ALUNO)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Gamifica√ß√£o
  xpTotal      Int @default(0)
  nivel        Int @default(1)
  proximoNivel Int @default(100)

  // Relacionamentos - Sistema Original
  avaliacoes                Avaliacao[]
  avaliacoesSocioemocionais AvaliacaoSocioemocional[]
  avaliacoesDidaticas       AvaliacaoDidatica[]
  avaliacoesProfessores     AvaliacaoProfessor[]
  humorRegistros            HumorRegistro[]
  aulasFavoritas            AulaFavorita[]

  // Relacionamentos - Sistema Adaptativo
  sessoesAdaptativas       SessaoAdaptativa[]
  respostasSocioemocionais RespostaSocioemocional[]
  alertasSocioemocionais   AlertaSocioemocional[]
  historicoEmocional       HistoricoEmocional[]

  // Relacionamentos - Gamifica√ß√£o
  conquistas UsuarioConquista[]
  badges     UsuarioBadge[]
  checkIns   CheckIn[]

  // Relacionamentos - Sistema
  notificacoes Notificacao[]
  logs         LogAtividade[]

  @@map("usuarios")
}

// Modelo Professor  
model Professor {
  id        Int      @id @default(autoincrement())
  nome      String
  email     String   @unique
  materia   String
  avatar    String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  aulas                 Aula[]
  avaliacoesProfessores AvaliacaoProfessor[]

  @@map("professores")
}

// Modelo Aula
model Aula {
  id          Int        @id @default(autoincrement())
  titulo      String
  descricao   String?
  materia     String
  dataHora    DateTime
  duracao     Int // em minutos
  professorId Int
  sala        String?
  status      StatusAula @default(AGENDADA)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relacionamentos
  professor                 Professor                 @relation(fields: [professorId], references: [id])
  avaliacoes                Avaliacao[]
  avaliacoesSocioemocionais AvaliacaoSocioemocional[]
  avaliacoesDidaticas       AvaliacaoDidatica[]
  aulasFavoritas            AulaFavorita[]
  eventos                   Evento[]
  sessoesAdaptativas        SessaoAdaptativa[] // Sess√µes de question√°rios socioemocionais vinculadas √† aula

  @@map("aulas")
}

// Modelo Avaliacao (Humor/Feedback da aula)
model Avaliacao {
  id        Int       @id @default(autoincrement())
  usuarioId Int
  aulaId    Int
  humor     TipoHumor
  nota      Int? // 1-5 estrelas
  feedback  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id])
  aula    Aula    @relation(fields: [aulaId], references: [id])

  // Um usu√°rio s√≥ pode avaliar uma aula uma vez
  @@unique([usuarioId, aulaId])
  @@map("avaliacoes")
}

// ==============================================
// NOVOS MODELOS - SISTEMA DE AVALIA√á√ÉO REESTRUTURADO
// ==============================================

// Modelo AvaliacaoSocioemocional (Question√°rio Adaptativo - Circumplex)
model AvaliacaoSocioemocional {
  id        Int @id @default(autoincrement())
  usuarioId Int
  aulaId    Int

  // Dados do Modelo Circumplex
  valencia       Float // -1.0 (negativo) a 1.0 (positivo)
  ativacao       Float // -1.0 (baixa energia) a 1.0 (alta energia)
  estadoPrimario String // "Animado", "Calmo", "Entediado", "Ansioso", etc.
  confianca      Float // 0.0 a 1.0 (confian√ßa da medi√ß√£o IRT)

  // Metadados do question√°rio adaptativo
  totalPerguntas Int // 5-12 perguntas
  tempoResposta  Int // em segundos
  respostas      String // JSON: [{perguntaId, valor, timestamp}]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id])
  aula    Aula    @relation(fields: [aulaId], references: [id])

  // Um usu√°rio s√≥ pode fazer avalia√ß√£o socioemocional uma vez por aula
  @@unique([usuarioId, aulaId])
  @@map("avaliacoes_socioemocionais")
}

// Modelo AvaliacaoDidatica (Avalia√ß√£o do Conte√∫do/Pedagogia)
model AvaliacaoDidatica {
  id        Int @id @default(autoincrement())
  usuarioId Int
  aulaId    Int

  // Crit√©rios did√°ticos (escala 1-5)
  compreensaoConteudo Int // O quanto entendeu o conte√∫do
  ritmoAula           Int // Velocidade adequada (1=muito lento, 5=muito r√°pido, 3=ideal)
  recursosDidaticos   Int // Qualidade dos slides, exemplos, materiais
  engajamento         Int // N√≠vel de envolvimento com a aula

  // Feedback estruturado (opcional)
  pontoPositivo String? // O que funcionou bem
  pontoMelhoria String? // O que pode melhorar
  sugestao      String? // Sugest√µes espec√≠ficas

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id])
  aula    Aula    @relation(fields: [aulaId], references: [id])

  // Um usu√°rio s√≥ pode fazer avalia√ß√£o did√°tica uma vez por aula
  @@unique([usuarioId, aulaId])
  @@map("avaliacoes_didaticas")
}

// Modelo AvaliacaoProfessor (Avalia√ß√£o Peri√≥dica/Coletiva do Professor)
model AvaliacaoProfessor {
  id          Int    @id @default(autoincrement())
  usuarioId   Int
  professorId Int
  periodo     String // "2025-10" (ano-m√™s) - limita 1 avalia√ß√£o por m√™s

  // Crit√©rios de avalia√ß√£o do professor (escala 1-5)
  dominioConteudo   Int // Conhecimento da mat√©ria
  clarezaExplicacao Int // Did√°tica e clareza
  pontualidade      Int // Pontualidade e assiduidade
  organizacao       Int // Organiza√ß√£o das aulas
  acessibilidade    Int // Disponibilidade para d√∫vidas
  empatia           Int // Empatia com alunos

  // Coment√°rio an√¥nimo (opcional)
  comentario String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  usuario   Usuario   @relation(fields: [usuarioId], references: [id])
  professor Professor @relation(fields: [professorId], references: [id])

  // Um usu√°rio s√≥ pode avaliar um professor uma vez por per√≠odo
  @@unique([usuarioId, professorId, periodo])
  @@map("avaliacoes_professores")
}

// Modelo HumorRegistro (Registro di√°rio de humor)
model HumorRegistro {
  id         Int       @id @default(autoincrement())
  usuarioId  Int
  humor      TipoHumor
  data       DateTime  @default(now())
  observacao String?
  createdAt  DateTime  @default(now())

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id])

  // Um usu√°rio s√≥ pode registrar humor uma vez por dia
  @@unique([usuarioId, data])
  @@map("humor_registros")
}

// Modelo AulaFavorita
model AulaFavorita {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  aulaId    Int
  createdAt DateTime @default(now())

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id])
  aula    Aula    @relation(fields: [aulaId], references: [id])

  // Um usu√°rio n√£o pode favoritar a mesma aula duas vezes
  @@unique([usuarioId, aulaId])
  @@map("aulas_favoritas")
}

// Modelo Evento (Calend√°rio)
model Evento {
  id         Int        @id @default(autoincrement())
  titulo     String
  descricao  String?
  dataInicio DateTime
  dataFim    DateTime?
  cor        String? // Hex color
  tipo       TipoEvento @default(EVENTO)
  aulaId     Int? // Opcional, pode ser evento n√£o relacionado a aula
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relacionamentos
  aula Aula? @relation(fields: [aulaId], references: [id])

  @@map("eventos")
}

// ==============================================
// SISTEMA DE QUESTION√ÅRIOS ADAPTATIVOS
// Base de Perguntas + Motor de Regras (json-rules-engine)
// ==============================================

// Modelo QuestionarioSocioemocional (Template de Question√°rio)
model QuestionarioSocioemocional {
  id        String  @id @default(uuid())
  titulo    String
  descricao String?
  versao    String  @default("1.0")

  // Configura√ß√µes
  tipo            TipoQuestionario
  frequencia      FrequenciaQuestionario? // Para question√°rios recorrentes
  duracaoEstimada Int? // Em minutos

  // Contexto principal (NOVO!)
  contextoPrincipal ContextoTipo @default(GERAL)

  // Categorias avaliadas
  categorias String[] // ["humor", "ansiedade", "motivacao", "relacionamentos"]

  // Configura√ß√µes de adapta√ß√£o
  adaptativo     Boolean         @default(false)
  nivelAdaptacao NivelAdaptacao?

  // Instru√ß√µes e metadados
  instrucoes       String? // Texto de introdu√ß√£o
  instrucoesFinais String? // Texto de conclus√£o
  tempoMinimo      Int? // Tempo m√≠nimo recomendado (segundos)
  tempoMaximo      Int? // Tempo m√°ximo recomendado (segundos)

  // P√∫blico-alvo
  idadeMinima Int?
  idadeMaxima Int?

  // Status e controle
  ativo          Boolean @default(true)
  oficial        Boolean @default(false) // Validado por psic√≥logos
  publicado      Boolean @default(false)
  versaoAnterior String? // UUID do question√°rio anterior

  // Auditoria
  criadoPorId  Int?
  criadoEm     DateTime  @default(now())
  atualizadoEm DateTime  @updatedAt
  publicadoEm  DateTime?

  // Relacionamentos
  perguntas PerguntaSocioemocional[]
  sessoes   SessaoAdaptativa[]
  alertas   AlertaSocioemocional[]
  regras    RegraAdaptacao[]

  @@index([tipo, ativo])
  @@index([publicado, ativo])
  @@index([contextoPrincipal, ativo]) // Novo √≠ndice para contexto
  @@map("questionarios_socioemocionais")
}

// Modelo PerguntaSocioemocional (Banco de Perguntas)
model PerguntaSocioemocional {
  id             String @id @default(uuid())
  questionarioId String

  // Conte√∫do da pergunta
  texto         String
  textoAuxiliar String? // Texto explicativo ou exemplo
  categoria     CategoriaPergunta
  dominio       DominioEmocional

  // Tipo e configura√ß√£o
  tipoPergunta TipoPergunta
  obrigatoria  Boolean      @default(true)
  ordem        Int // Ordem dentro do question√°rio

  // Op√ß√µes de resposta (JSON para flexibilidade)
  opcoes Json? // Para multiple choice, checkboxes, etc
  // Exemplo: [{"valor": 1, "label": "Discordo totalmente"}, ...]

  // Valida√ß√£o
  valorMinimo    Float?
  valorMaximo    Float?
  padraoResposta String? // Regex para validar texto

  // Metadados para adapta√ß√£o
  dificuldade   Float @default(0.5) // 0.0 = f√°cil, 1.0 = dif√≠cil (IRT)
  discriminacao Float @default(1.0) // Poder discriminat√≥rio (IRT)
  peso          Float @default(1.0) // Peso na pontua√ß√£o final

  // Escala de refer√™ncia (se aplic√°vel)
  escalaNome String? // "WHO-5", "PHQ-9", "GAD-7", "PSS-10"
  escalaItem String? // "WHO5_1", "PHQ9_2", etc

  // Tags e busca
  tags          String[] // ["ansiedade", "sono", "concentracao"]
  palavrasChave String[] // Para busca sem√¢ntica

  // Status
  ativo    Boolean @default(true)
  validada Boolean @default(false) // Validada por psic√≥logos

  // Auditoria
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relacionamentos
  questionario QuestionarioSocioemocional @relation(fields: [questionarioId], references: [id], onDelete: Cascade)
  respostas    RespostaSocioemocional[]

  @@index([categoria, ativo])
  @@index([dominio, ativo])
  @@index([escalaNome])
  @@index([questionarioId, ordem])
  @@map("perguntas_socioemocionais")
}

// Modelo BancoPerguntasAdaptativo (Perguntas Din√¢micas)
model BancoPerguntasAdaptativo {
  id String @id @default(uuid())

  // Identifica√ß√£o
  codigo        String  @unique // "GAD7_001", "PHQ9_005"
  titulo        String
  texto         String
  textoAuxiliar String?

  // Classifica√ß√£o
  categoria    CategoriaPergunta
  dominio      DominioEmocional
  subcategoria String? // Subcategoria espec√≠fica

  // Tipo e configura√ß√£o
  tipoPergunta TipoPergunta
  opcoes       Json? // Op√ß√µes de resposta

  // Metadados IRT (Item Response Theory)
  parametroA Float @default(1.0) // Discrimina√ß√£o
  parametroB Float @default(0.0) // Dificuldade
  parametroC Float @default(0.0) // Chute (para m√∫ltipla escolha)

  // Escala de refer√™ncia
  escalaNome   String?
  escalaItem   String?
  escalaVersao String?

  // Condi√ß√µes de uso
  condicoes Json? // Regras para quando usar esta pergunta
  // Exemplo: {"minimumScore": 5, "domains": ["ansiedade", "sono"]}

  // Uso e estat√≠sticas
  vezesUsada         Int    @default(0)
  taxaResposta       Float? // Taxa de resposta completa
  tempoMedioResposta Int? // Segundos

  // Status
  ativo    Boolean @default(true)
  validada Boolean @default(false)

  // Relacionamentos
  respostas RespostaSocioemocional[] // Respostas que usaram esta pergunta

  // Auditoria
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([categoria, dominio, ativo])
  @@index([escalaNome])
  @@index([codigo])
  @@map("banco_perguntas_adaptativo")
}

// Modelo RegraAdaptacao (Motor de Regras - json-rules-engine)
model RegraAdaptacao {
  id             String @id @default(uuid())
  questionarioId String

  // Identifica√ß√£o
  nome       String
  descricao  String?
  prioridade Int     @default(0) // Maior = mais priorit√°ria

  // Condi√ß√µes (JSON compat√≠vel com json-rules-engine)
  condicoes Json
  // Exemplo: {"all": [{"fact": "ansiedade", "operator": "greaterThan", "value": 7}]}

  // A√ß√µes a executar quando regra √© ativada
  acoes Json
  // Exemplo: [{"type": "INSERIR_PERGUNTA", "params": {"perguntaId": "..."}}]

  // Metadados
  tipoCondicao TipoCondicao
  tipoAcao     TipoAcao[]

  // Configura√ß√µes
  executarUmaVez Boolean @default(false)
  executarSempre Boolean @default(false)
  ordemExecucao  Int     @default(0)

  // Evento que dispara a regra
  eventoGatilho EventoGatilho?

  // Status e estat√≠sticas
  ativo             Boolean   @default(true)
  vezesAcionada     Int       @default(0)
  ultimoAcionamento DateTime?

  // Auditoria
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relacionamento
  questionario QuestionarioSocioemocional @relation(fields: [questionarioId], references: [id], onDelete: Cascade)

  @@index([questionarioId, ativo, prioridade])
  @@index([tipoCondicao, tipoAcao])
  @@map("regras_adaptacao")
}

// Modelo SessaoAdaptativa (Sess√£o de Resposta em Tempo Real)
model SessaoAdaptativa {
  id             String @id @default(uuid())
  usuarioId      Int
  questionarioId String

  // Estado da sess√£o
  status    StatusSessao @default(EM_ANDAMENTO)
  progresso Float        @default(0.0) // 0.0 a 1.0

  // Contexto da sess√£o (NOVO!)
  contextoTipo     ContextoTipo @default(GERAL)
  contextoMetadata Json? // Dados extras do contexto (origem, detalhes, etc)

  // Perguntas e respostas
  perguntasApresentadas String[] // Array de UUIDs
  perguntasRespondidas  String[] // Array de UUIDs
  perguntaAtual         String? // UUID da pergunta atual
  proximaPergunta       String? // UUID (pr√©-calculado)

  // Estimativas adaptativas (IRT)
  thetaEstimado Float? // Theta atual (n√≠vel do tra√ßo latente)
  erroEstimacao Float? // Erro padr√£o da estimativa
  confianca     Float? // Confian√ßa da medi√ß√£o (0-1)

  // Alertas em tempo real
  nivelAlerta    NivelAlerta @default(VERDE)
  alertasGerados String[] // Array de UUIDs de alertas

  // Tempo e metadata
  iniciadoEm         DateTime  @default(now())
  pausadoEm          DateTime? // Quando foi pausada
  finalizadoEm       DateTime?
  tempoTotalSegundos Int?
  tempoMedioResposta Int? // Tempo m√©dio por resposta em segundos

  // Estimativas e scores
  totalPerguntasEstimado Int? // Total estimado de perguntas (para adaptativos)
  scoresPorCategoria     Json? // Scores finais por categoria { "BEM_ESTAR": 7, "SONO": 6 }

  // Contexto adicional
  contexto    Json? // Dados extras (localiza√ß√£o, humor pr√©vio, etc) - DEPRECATED, use contextoMetadata
  dispositivo String? // "mobile", "desktop", "tablet"
  aulaId      Int? // ID da aula (se contexto = AULA)
  eventoId    String? // ID do evento (se contexto = EVENTO)

  // Relacionamentos
  usuario      Usuario                    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  questionario QuestionarioSocioemocional @relation(fields: [questionarioId], references: [id])
  aula         Aula?                      @relation(fields: [aulaId], references: [id], onDelete: SetNull)
  respostas    RespostaSocioemocional[]
  alertas      AlertaSocioemocional[]

  @@index([usuarioId, status])
  @@index([questionarioId, status])
  @@index([nivelAlerta])
  @@index([contextoTipo, status]) // Novo √≠ndice para queries por contexto
  @@map("sessoes_adaptativas")
}

// Modelo RespostaSocioemocional (Respostas das Perguntas)
model RespostaSocioemocional {
  id         String  @id @default(uuid())
  sessaoId   String
  perguntaId String? // OPCIONAL: pode ser do question√°rio ou do banco adaptativo
  usuarioId  Int

  // Refer√™ncia ao banco adaptativo (alternativa ao perguntaId)
  perguntaBancoId String? // ID da pergunta no BancoPerguntasAdaptativo

  // Resposta
  valor            Json // Valor da resposta (pode ser string, number, array, etc)
  valorNumerico    Float? // Valor num√©rico quando aplic√°vel
  valorTexto       String? // Valor texto quando aplic√°vel
  valorNormalizado Float? // Valor normalizado para c√°lculos (0.0 a 1.0)

  // Categoria e dom√≠nio (denormalizado para queries r√°pidas)
  categoria  CategoriaPergunta?
  dominio    DominioEmocional?
  escalaNome String? // Nome da escala (ex: "WHO5", "PHQ9")
  escalaItem String? // Item da escala (ex: "PHQ9_9")

  // Metadados da resposta
  tempoResposta Int // Tempo em segundos para responder
  tentativas    Int      @default(1)
  alterada      Boolean  @default(false) // Se mudou a resposta
  respondidoEm  DateTime @default(now()) // Timestamp de resposta

  // An√°lise emocional (Modelo Circumplex)
  valencia Float? // -1.0 (negativo) a 1.0 (positivo)
  ativacao Float? // -1.0 (baixa energia) a 1.0 (alta energia)

  // IRT - Item Response Theory
  thetaAposResposta Float? // Theta estimado ap√≥s esta resposta
  contribuicaoInfo  Float? // Contribui√ß√£o de informa√ß√£o desta resposta

  // Contexto
  timestamp DateTime @default(now())
  ordem     Int // Ordem da resposta na sess√£o

  // Relacionamentos
  sessao        SessaoAdaptativa        @relation(fields: [sessaoId], references: [id], onDelete: Cascade)
  pergunta      PerguntaSocioemocional? @relation(fields: [perguntaId], references: [id])
  perguntaBanco BancoPerguntasAdaptativo? @relation(fields: [perguntaBancoId], references: [id])
  usuario       Usuario                 @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([sessaoId, ordem])
  @@index([usuarioId, timestamp])
  @@index([perguntaId])
  @@index([perguntaBancoId])
  @@map("respostas_socioemocionais")
}

// Modelo AlertaSocioemocional (Sistema de Alertas)
model AlertaSocioemocional {
  id             String  @id @default(uuid())
  usuarioId      Int
  sessaoId       String?
  questionarioId String

  // Classifica√ß√£o do alerta
  nivel     NivelAlerta
  tipo      TipoAlerta
  categoria CategoriaPergunta
  dominio   DominioEmocional?

  // Conte√∫do
  titulo        String
  mensagem      String? // Mensagem curta do alerta
  descricao     String
  recomendacoes Json? // Array de a√ß√µes recomendadas

  // Dados que geraram o alerta
  dadosContexto   Json // Respostas e scores que acionaram
  regrasAcionadas String[] // UUIDs das regras que geraram o alerta

  // Pontua√ß√µes
  scoreTotal   Float?
  scoreDominio Float?
  desvioMedia  Float? // Quantos desvios da m√©dia do usu√°rio

  // Status e tratamento
  status       StatusAlerta @default(PENDENTE)
  ativo        Boolean      @default(true) // Se o alerta ainda est√° ativo
  lido         Boolean      @default(false)
  lidoEm       DateTime?
  notificado   Boolean      @default(false)
  notificadoEm DateTime?

  // A√ß√µes tomadas
  acao         String? // "ENCAMINHADO_PSICOLOGO", "LIGACAO_FEITA", etc
  observacoes  String?
  resolvidoEm  DateTime?
  resolvidoPor Int? // ID do profissional que tratou

  // Auditoria
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relacionamentos
  usuario      Usuario                    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  sessao       SessaoAdaptativa?          @relation(fields: [sessaoId], references: [id])
  questionario QuestionarioSocioemocional @relation(fields: [questionarioId], references: [id])

  @@index([usuarioId, nivel, status])
  @@index([nivel, status, criadoEm])
  @@index([categoria, nivel])
  @@map("alertas_socioemocionais")
}

// Modelo HistoricoEmocional (Evolu√ß√£o Temporal)
model HistoricoEmocional {
  id        String @id @default(uuid())
  usuarioId Int

  // Per√≠odo
  data    DateTime
  periodo PeriodoHistorico // DIA, SEMANA, MES

  // M√©tricas do Modelo Circumplex
  valenciaMedia   Float // -1.0 a 1.0
  ativacaoMedia   Float // -1.0 a 1.0
  estadoDominante String // "Animado", "Calmo", "Ansioso", etc

  // Dom√≠nios emocionais (scores 0-10)
  scoreHumor           Float?
  scoreAnsiedade       Float?
  scoreEstresse        Float?
  scoreMotivacao       Float?
  scoreSono            Float?
  scoreRelacionamentos Float?
  scoreAutoestima      Float?

  // Estat√≠sticas
  totalAvaliacoes Int    @default(0)
  taxaResposta    Float? // % de question√°rios respondidos

  // Tend√™ncias
  tendenciaValencia String? // "CRESCENTE", "ESTAVEL", "DECRESCENTE"
  tendenciaAtivacao String?

  // Alertas no per√≠odo
  totalAlertas     Int @default(0)
  alertasVermelhos Int @default(0)
  alertasLaranjas  Int @default(0)
  alertasAmarelos  Int @default(0)

  // Compara√ß√£o com m√©dia
  desvioValencia Float? // Desvio da m√©dia geral
  desvioAtivacao Float?

  // Relacionamento
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, data, periodo])
  @@index([usuarioId, periodo, data])
  @@map("historico_emocional")
}

// ==============================================
// SISTEMA DE GAMIFICA√á√ÉO
// ==============================================

// Modelo Conquista (Achievements)
model Conquista {
  id String @id @default(uuid())

  // Identifica√ß√£o
  codigo    String             @unique // "FIRST_CHECKIN", "STREAK_7_DAYS"
  titulo    String
  descricao String
  categoria CategoriaConquista

  // Recompensas
  xp    Int // XP ganho ao conquistar
  icone String // Nome do √≠cone ou URL
  cor   String? // Cor associada (hex)

  // Dificuldade
  raridade Raridade

  // Crit√©rios
  criterios Json // Condi√ß√µes para desbloquear
  // Exemplo: {"checkinsTotal": 30, "diasConsecutivos": 7}

  // Status
  ativo  Boolean @default(true)
  oculta Boolean @default(false) // Conquista secreta

  // Relacionamento
  usuarios UsuarioConquista[]

  @@index([categoria, raridade])
  @@map("conquistas")
}

// Modelo UsuarioConquista (Join table)
model UsuarioConquista {
  id          String @id @default(uuid())
  usuarioId   Int
  conquistaId String

  // Metadata
  conquistadoEm DateTime @default(now())
  progresso     Float    @default(1.0) // 0.0 a 1.0
  notificado    Boolean  @default(false)

  // Relacionamentos
  usuario   Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  conquista Conquista @relation(fields: [conquistaId], references: [id])

  @@unique([usuarioId, conquistaId])
  @@index([usuarioId])
  @@map("usuarios_conquistas")
}

// Modelo Badge (Distintivos)
model Badge {
  id String @id @default(uuid())

  // Identifica√ß√£o
  codigo    String @unique
  titulo    String
  descricao String

  // Visual
  icone    String
  cor      String?
  animacao String? // URL de anima√ß√£o (Lottie, GIF)

  // Tipo
  tipo      TipoBadge
  categoria CategoriaBadge

  // Crit√©rios
  criterios Json

  // Status
  ativo Boolean @default(true)

  // Relacionamento
  usuarios UsuarioBadge[]

  @@map("badges")
}

// Modelo UsuarioBadge (Join table)
model UsuarioBadge {
  id        String @id @default(uuid())
  usuarioId Int
  badgeId   String

  // Metadata
  conquistadoEm DateTime @default(now())
  nivel         Int      @default(1) // Alguns badges t√™m n√≠veis

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  badge   Badge   @relation(fields: [badgeId], references: [id])

  @@unique([usuarioId, badgeId])
  @@index([usuarioId])
  @@map("usuarios_badges")
}

// Modelo CheckIn (Check-ins di√°rios)
model CheckIn {
  id        String @id @default(uuid())
  usuarioId Int

  // Data e hora
  data DateTime @default(now())
  hora String // "08:30", "14:45"

  // Humor r√°pido (0-10)
  humor Int
  emoji String? // Emoji escolhido

  // Observa√ß√µes opcionais
  observacao String?
  atividades String[] // ["estudou", "exercicio", "amigos"]

  // Contexto
  localizacao String? // "casa", "escola", "trabalho"
  clima       String? // "ensolarado", "chuvoso"

  // Gamifica√ß√£o
  xpGanho Int @default(10)
  streak  Int @default(1) // Dias consecutivos

  // Relacionamento
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, data])
  @@index([usuarioId, data])
  @@map("checkins")
}

// ==============================================
// NOTIFICA√á√ïES E LEMBRETES
// ==============================================

// Modelo Notificacao
model Notificacao {
  id        String @id @default(uuid())
  usuarioId Int

  // Conte√∫do
  tipo     TipoNotificacao
  titulo   String
  mensagem String
  dados    Json? // Dados extras (IDs, links, etc)

  // Visual
  icone      String?
  cor        String?
  prioridade PrioridadeNotificacao @default(NORMAL)

  // A√ß√£o
  acao      String? // Rota para navegar
  acaoLabel String? // "Ver agora", "Responder", etc

  // Status
  lida      Boolean   @default(false)
  lidaEm    DateTime?
  enviada   Boolean   @default(false)
  enviadaEm DateTime?

  // Agendamento
  agendadaPara DateTime?
  expiraEm     DateTime?

  // Canais
  pushNotification  Boolean @default(false)
  emailNotification Boolean @default(false)

  // Auditoria
  criadoEm DateTime @default(now())

  // Relacionamento
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId, lida, criadoEm])
  @@index([tipo, enviada])
  @@map("notificacoes")
}

// ==============================================
// LOGS E AUDITORIA
// ==============================================

// Modelo LogAtividade
model LogAtividade {
  id        String @id @default(uuid())
  usuarioId Int?

  // Atividade
  tipo       TipoLog
  acao       String // "LOGIN", "RESPOSTA_QUESTIONARIO", "VISUALIZOU_ALERTA"
  entidade   String? // "Usuario", "Questionario", "Alerta"
  entidadeId String? // UUID da entidade

  // Dados
  dados Json?

  // Contexto t√©cnico
  ipAddress   String?
  userAgent   String?
  dispositivo String?

  // Timestamp
  criadoEm DateTime @default(now())

  // Relacionamento
  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  @@index([usuarioId, tipo, criadoEm])
  @@index([tipo, criadoEm])
  @@map("logs_atividades")
}

// ==============================================
// ENUMS
// ==============================================

enum Role {
  ALUNO
  PROFESSOR
  ADMIN
}

enum TipoHumor {
  MUITO_TRISTE // üò¢ 1
  TRISTE // üòï 2  
  NEUTRO // üòê 3
  FELIZ // üôÇ 4
  MUITO_FELIZ // üòÑ 5
}

enum StatusAula {
  AGENDADA
  EM_ANDAMENTO
  CONCLUIDA
  CANCELADA
}

enum TipoEvento {
  AULA
  PROVA
  EVENTO
  FERIADO
  REUNIAO
}

// ==============================================
// ENUMS DO SISTEMA ADAPTATIVO
// ==============================================

enum TipoQuestionario {
  CHECK_IN_DIARIO
  AVALIACAO_SEMANAL
  AVALIACAO_MENSAL
  AVALIACAO_POS_AULA
  AVALIACAO_CRITICA // Momento de crise/interven√ß√£o
  QUESTIONARIO_INICIAL // Onboarding
  QUESTIONARIO_FINAL // Fim do per√≠odo
  PESQUISA_SATISFACAO
  AUTOAVALIACAO
}

enum FrequenciaQuestionario {
  DIARIO
  SEMANAL
  QUINZENAL
  MENSAL
  TRIMESTRAL
  SEMESTRAL
  ANUAL
  SOB_DEMANDA
}

enum NivelAdaptacao {
  BAIXO // Apenas skip logic b√°sico
  MEDIO // Regras condicionais simples
  ALTO // Regras complexas + banco de perguntas
  MUITO_ALTO // IRT + Machine Learning
}

enum CategoriaPergunta {
  HUMOR_GERAL
  ANSIEDADE
  DEPRESSAO
  ESTRESSE
  SONO
  CONCENTRACAO
  MOTIVACAO
  RELACIONAMENTOS
  AUTOESTIMA
  ENERGIA
  FADIGA
  IRRITABILIDADE
  PENSAMENTOS_NEGATIVOS
  APOIO_SOCIAL
  DESEMPENHO_ACADEMICO
  SATISFACAO_VIDA
  BEM_ESTAR
  SAUDE_FISICA
}

enum DominioEmocional {
  // Modelo Circumplex de Russell
  ANIMADO // Alta ativa√ß√£o + Val√™ncia positiva
  ENTUSIASMADO
  EUF√ìRICO
  EXCITADO
  FELIZ
  CONTENTE
  CALMO // Baixa ativa√ß√£o + Val√™ncia positiva
  RELAXADO
  SERENO
  TRANQUILO
  ENTEDIADO // Baixa ativa√ß√£o + Val√™ncia negativa
  CANSADO
  DEPRIMIDO
  LETARGICO
  TRISTE
  ANSIOSO // Alta ativa√ß√£o + Val√™ncia negativa
  ESTRESSADO
  NERVOSO
  TENSO
  IRRITADO
  NEUTRO // Centro (0,0)
}

enum TipoPergunta {
  LIKERT_5 // 1-5 (Discordo totalmente ‚Üí Concordo totalmente)
  LIKERT_7 // 1-7
  LIKERT_10 // 0-10
  ESCALA_VISUAL // Slider visual
  MULTIPLA_ESCOLHA // Apenas uma op√ß√£o
  MULTIPLA_SELECAO // M√∫ltiplas op√ß√µes (checkboxes)
  TEXTO_CURTO // Input text (max 200 chars)
  TEXTO_LONGO // Textarea (max 1000 chars)
  SIM_NAO // Boolean
  EMOJI_PICKER // Seletor de emojis
  SLIDER_NUMERICO // Range slider
  ESCALA_FREQUENCIA // "Nunca", "Raramente", "√Äs vezes", "Frequentemente", "Sempre"
  ESCALA_INTENSIDADE // "Nada", "Pouco", "Moderado", "Muito", "Extremamente"
  DATA // Date picker
  HORA // Time picker
  RANKING // Ordenar op√ß√µes por prefer√™ncia
}

enum TipoCondicao {
  VALOR_EXATO // resposta === valor
  VALOR_DIFERENTE // resposta !== valor
  MAIOR_QUE // resposta > valor
  MENOR_QUE // resposta < valor
  MAIOR_OU_IGUAL // resposta >= valor
  MENOR_OU_IGUAL // resposta <= valor
  RANGE_NUMERICO // valor entre X e Y
  CONTEM_TEXTO // resposta.includes(texto)
  MULTIPLAS_RESPOSTAS // array de respostas
  PADRAO_TEMPORAL // an√°lise de hist√≥rico
  DESVIO_PADRAO // desvio > X da m√©dia
  TENDENCIA // tend√™ncia crescente/decrescente
}

enum TipoAcao {
  INSERIR_PERGUNTA // Adiciona pergunta espec√≠fica
  PULAR_SECAO // Pula pr√≥xima se√ß√£o
  FINALIZAR_QUESTIONARIO // Encerra question√°rio
  BUSCAR_BANCO // Busca pergunta no banco adaptativo
  CRIAR_ALERTA // Gera alerta socioemocional
  NOTIFICAR_PROFISSIONAL // Envia notifica√ß√£o para psic√≥logo
  ALTERAR_FLUXO // Muda sequ√™ncia de perguntas
  RECOMENDAR_RECURSO // Sugere recurso de apoio
}

enum EventoGatilho {
  INICIO_QUESTIONARIO
  FIM_QUESTIONARIO
  RESPOSTA_INDIVIDUAL
  GRUPO_RESPOSTAS
  TEMPO_DECORRIDO
  PADRAO_DETECTADO
}

enum StatusSessao {
  EM_ANDAMENTO
  PAUSADA
  FINALIZADA
  CANCELADA
  EXPIRADA
}

enum ContextoTipo {
  GERAL // Question√°rios especializados (/avaliacoes/*)
  AULA // Avalia√ß√£o socioemocional de aula
  CHECK_IN // Check-in di√°rio
  EVENTO // Eventos especiais (futuro)
}

enum NivelAlerta {
  VERDE // Tudo OK
  AMARELO // Aten√ß√£o leve
  LARANJA // Preocupa√ß√£o moderada
  VERMELHO // Urgente - interven√ß√£o necess√°ria
}

enum TipoAlerta {
  RISCO_BAIXO
  RISCO_MODERADO
  RISCO_ALTO
  CRISE_IMEDIATA
  PADRAO_PREOCUPANTE
  MELHORA_SIGNIFICATIVA
  ESTAVEL
}

enum StatusAlerta {
  PENDENTE
  EM_ANALISE
  NOTIFICADO
  EM_ACOMPANHAMENTO
  RESOLVIDO
  FALSO_POSITIVO
  ARQUIVADO
}

enum PeriodoHistorico {
  DIA
  SEMANA
  MES
  TRIMESTRE
  SEMESTRE
  ANO
}

enum CategoriaConquista {
  ENGAJAMENTO // Check-ins, respostas
  CONSISTENCIA // Streaks, regularidade
  PROGRESSO // Melhoras no bem-estar
  SOCIAL // Intera√ß√µes, ajuda
  APRENDIZADO // Completar tutoriais
  ESPECIAL // Eventos especiais
  SECRETA // Conquistas ocultas
}

enum Raridade {
  COMUM
  INCOMUM
  RARO
  EPICO
  LENDARIO
}

enum TipoBadge {
  PERMANENTE // Badge que nunca expira
  TEMPORARIO // Badge por tempo limitado
  PROGRESSIVO // Badge com n√≠veis (Bronze ‚Üí Prata ‚Üí Ouro)
  SAZONAL // Badge de eventos especiais
}

enum CategoriaBadge {
  FREQUENCIA // "7 dias seguidos"
  CONQUISTA // "100 check-ins"
  QUALIDADE // "10 respostas completas"
  ESPECIAL // Eventos, datas comemorativas
  ELITE // Top performers
}

enum TipoNotificacao {
  LEMBRETE_CHECKIN
  LEMBRETE_QUESTIONARIO
  ALERTA_EMOCIONAL
  CONQUISTA_DESBLOQUEADA
  BADGE_GANHO
  NIVEL_SUBIU
  MENSAGEM_SISTEMA
  MENSAGEM_PROFISSIONAL
  ATUALIZACAO
  DICA_BEM_ESTAR
}

enum PrioridadeNotificacao {
  BAIXA
  NORMAL
  ALTA
  URGENTE
}

enum TipoLog {
  AUTENTICACAO
  NAVEGACAO
  ACAO_USUARIO
  SISTEMA
  ERRO
  ALERTA
  INTEGRACAO
}

// ==============================================
// PRISMA SCHEMA - ClassCheck
// Database: PostgreSQL 16
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// MODELOS DO CLASSCHECK
// ==============================================

// Modelo Usuario
model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  nome      String   @db.VarChar(255)
  avatar    String?  @db.Text
  role      Role     @default(ALUNO)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  avaliacoes            Avaliacao[]
  humorRegistros        HumorRegistro[]
  aulasFavoritas        AulaFavorita[]
  perfilGamificacao     PerfilGamificacao?
  configuracoesRanking  ConfiguracaoRanking[]

  @@map("usuarios")
}

// Modelo Professor  
model Professor {
  id        Int      @id @default(autoincrement())
  nome      String   @db.VarChar(255)
  email     String   @unique @db.VarChar(255)
  materia   String   @db.VarChar(255)
  avatar    String?  @db.Text
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  aulas Aula[]

  @@map("professores")
}

// Modelo Aula
model Aula {
  id          Int      @id @default(autoincrement())
  titulo      String   @db.VarChar(255)
  descricao   String?  @db.Text
  materia     String   @db.VarChar(255)
  dataHora    DateTime
  duracao     Int      // em minutos
  professorId Int
  sala        String?  @db.VarChar(100)
  status      StatusAula @default(AGENDADA)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  professor      Professor      @relation(fields: [professorId], references: [id])
  avaliacoes     Avaliacao[]
  aulasFavoritas AulaFavorita[]
  eventos        Evento[]
  historicoXP    HistoricoXP[]

  @@map("aulas")
}

// Modelo Avaliacao (Humor/Feedback da aula)
model Avaliacao {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  aulaId    Int
  humor     TipoHumor
  nota      Int?     @db.SmallInt // 1-5 estrelas
  feedback  String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id])
  aula    Aula    @relation(fields: [aulaId], references: [id])

  // Um usu치rio s칩 pode avaliar uma aula uma vez
  @@unique([usuarioId, aulaId])
  @@map("avaliacoes")
}

// Modelo HumorRegistro (Registro di치rio de humor)
model HumorRegistro {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  humor     TipoHumor
  data      DateTime @default(now()) @db.Date
  observacao String? @db.Text
  createdAt DateTime @default(now())

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id])

  // Um usu치rio s칩 pode registrar humor uma vez por dia
  @@unique([usuarioId, data])
  @@map("humor_registros")
}

// Modelo AulaFavorita
model AulaFavorita {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  aulaId    Int
  createdAt DateTime @default(now())

  // Relacionamentos
  usuario Usuario @relation(fields: [usuarioId], references: [id])
  aula    Aula    @relation(fields: [aulaId], references: [id])

  // Um usu치rio n칚o pode favoritar a mesma aula duas vezes
  @@unique([usuarioId, aulaId])
  @@map("aulas_favoritas")
}

// Modelo Evento (Calend치rio)
model Evento {
  id        Int         @id @default(autoincrement())
  titulo    String      @db.VarChar(255)
  descricao String?     @db.Text
  dataInicio DateTime
  dataFim   DateTime?
  cor       String?     @db.VarChar(7) // Hex color
  tipo      TipoEvento  @default(EVENTO)
  aulaId    Int?        // Opcional, pode ser evento n칚o relacionado a aula
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relacionamentos
  aula Aula? @relation(fields: [aulaId], references: [id])

  @@map("eventos")
}

// ==============================================
// ENUMS
// ==============================================

enum Role {
  ALUNO
  PROFESSOR
  ADMIN
}

enum TipoHumor {
  MUITO_TRISTE  // 游땩 1
  TRISTE        // 游땟 2  
  NEUTRO        // 游땛 3
  FELIZ         // 游뗵 4
  MUITO_FELIZ   // 游땏 5
}

enum StatusAula {
  AGENDADA
  EM_ANDAMENTO
  CONCLUIDA  
  CANCELADA
}

enum TipoEvento {
  AULA
  PROVA
  EVENTO
  FERIADO
  REUNIAO
}

enum PeriodoRanking {
  SEMANAL
  MENSAL
  BIMESTRAL
}

enum VisibilidadeRanking {
  PUBLICO
  APENAS_TOP3
  PRIVADO
}

// ==============================================
// MODELOS DE GAMIFICA칂츾O
// ==============================================

// Perfil de Gamifica칞칚o do Usu치rio
model PerfilGamificacao {
  id                    Int      @id @default(autoincrement())
  usuarioId             Int      @unique
  xpTotal               Int      @default(0)
  nivel                 Int      @default(1)
  streakAtual           Int      @default(0)
  melhorStreak          Int      @default(0)
  ultimaAtividade       DateTime?
  totalAvaliacoes       Int      @default(0)
  avaliacoesConsecutivas Int     @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relacionamentos
  usuario                  Usuario              @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  historicoXP              HistoricoXP[]
  rankingPosicoes          RankingPosicao[]
  conquistasDesbloqueadas  ConquistaUsuario[]

  @@map("perfis_gamificacao")
}

// Hist칩rico de XP
model HistoricoXP {
  id            Int      @id @default(autoincrement())
  perfilId      Int
  xpGanho       Int
  acao          String   @db.VarChar(100)
  descricao     String?  @db.Text
  aulaId        Int?
  multiplicador Float    @default(1.0)
  createdAt     DateTime @default(now())

  // Relacionamentos
  perfil PerfilGamificacao @relation(fields: [perfilId], references: [id], onDelete: Cascade)
  aula   Aula?             @relation(fields: [aulaId], references: [id], onDelete: SetNull)

  @@map("historico_xp")
}

// Configura칞칚o de Ranking
model ConfiguracaoRanking {
  id                    Int                  @id @default(autoincrement())
  ativo                 Boolean              @default(true)
  periodoCalculo        PeriodoRanking       @default(SEMANAL)
  bonusPrimeiroLugar    Float                @default(0.3)
  bonusSegundoLugar     Float                @default(0.2)
  bonusTerceiroLugar    Float                @default(0.1)
  minimoAvaliacoes      Int                  @default(5)
  aplicarAutomaticamente Boolean             @default(true)
  notificarAlunos       Boolean              @default(true)
  visibilidadeRanking   VisibilidadeRanking  @default(PUBLICO)
  materiaId             String?              @db.VarChar(255)
  criadoPorId           Int
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relacionamentos
  criadoPor       Usuario          @relation(fields: [criadoPorId], references: [id])
  rankingPosicoes RankingPosicao[]

  @@map("configuracoes_ranking")
}

// Posi칞칚o no Ranking
model RankingPosicao {
  id              Int      @id @default(autoincrement())
  configuracaoId  Int
  perfilId        Int
  posicao         Int
  xpPeriodo       Int
  bonusAplicado   Float
  periodoInicio   DateTime
  periodoFim      DateTime
  aplicadoEm      DateTime?
  createdAt       DateTime @default(now())

  // Relacionamentos
  configuracao ConfiguracaoRanking @relation(fields: [configuracaoId], references: [id], onDelete: Cascade)
  perfil       PerfilGamificacao   @relation(fields: [perfilId], references: [id], onDelete: Cascade)

  @@map("ranking_posicoes")
}

// Modelo Conquista
model Conquista {
  id            Int      @id @default(autoincrement())
  tipo          String   @unique @db.VarChar(100)
  nome          String   @db.VarChar(255)
  descricao     String   @db.Text
  icone         String   @db.VarChar(10)
  categoria     String   @db.VarChar(50)
  xpRecompensa  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relacionamentos
  usuarios ConquistaUsuario[]

  @@map("conquistas")
}

// Modelo ConquistaUsuario (relacionamento muitos-para-muitos)
model ConquistaUsuario {
  id              Int      @id @default(autoincrement())
  perfilId        Int
  conquistaId     Int
  desbloqueadaEm  DateTime @default(now())
  createdAt       DateTime @default(now())

  // Relacionamentos
  perfil     PerfilGamificacao @relation(fields: [perfilId], references: [id], onDelete: Cascade)
  conquista  Conquista         @relation(fields: [conquistaId], references: [id], onDelete: Cascade)

  // Um perfil n칚o pode desbloquear a mesma conquista duas vezes
  @@unique([perfilId, conquistaId])
  @@map("conquistas_usuarios")
}

